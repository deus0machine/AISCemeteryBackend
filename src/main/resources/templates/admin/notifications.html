<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞–¥–±–∏—â–µ–º</title>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #198754;
            --danger-color: #dc3545;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }

        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar {
            background: var(--primary-color);
            min-height: 100vh;
            transition: transform 0.3s ease;
        }

        .sidebar .nav-link {
            color: rgba(255,255,255,0.7);
            border-left: 3px solid transparent;
        }

        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.1);
            border-left-color: var(--secondary-color);
            color: white;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card-modern {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #eaeaea;
            padding: 15px 20px;
        }

        .card-title {
            margin-bottom: 0;
            color: var(--primary-color);
            font-weight: 600;
        }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .btn-action {
            width: 36px;
            height: 36px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .stat-card {
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }
        
        .stat-primary {
            background-color: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }
        
        .stat-success {
            background-color: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
        }
        
        .stat-warning {
            background-color: rgba(241, 196, 15, 0.1);
            color: #f1c40f;
        }
        
        .stat-danger {
            background-color: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification-item {
            border-left: 4px solid transparent;
            transition: background-color 0.2s;
        }
        
        .notification-item:hover {
            background-color: rgba(0,0,0,0.02);
        }
        
        .notification-item.unread {
            border-left-color: var(--secondary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .notification-item.urgent {
            border-left-color: var(--danger-color);
        }
        
        .notification-type {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }
        
        .notification-date {
            font-size: 0.85rem;
            color: #6c757d;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
<!-- –®–∞–ø–∫–∞ -->
<header class="navbar navbar-dark bg-primary shadow-sm">
    <div class="container-fluid">
        <button class="navbar-toggler d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand" href="/admin">
            <i class="bi bi-building-gear me-2"></i>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
        </a>
        <div class="dropdown">
            <a href="#" class="text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle me-2"></i>
                <span sec:authentication="name"></span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <form th:action="@{/logout}" method="post">
                        <button class="dropdown-item" type="submit">
                            <i class="bi bi-box-arrow-right me-2"></i>–í—ã–π—Ç–∏
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </div>
</header>

<div class="container-fluid">
    <div class="row">
        <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
        <nav class="col-md-3 col-lg-2 sidebar collapse d-md-block" id="sidebarMenu">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin">
                            <i class="bi bi-speedometer2 me-2"></i>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/users">
                            <i class="bi bi-people-fill me-2"></i>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/memorials">
                            <i class="bi bi-bookmark-heart me-2"></i>–ú–µ–º–æ—Ä–∏–∞–ª—ã
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/family-trees">
                            <i class="bi bi-diagram-3 me-2"></i>–°–µ–º–µ–π–Ω—ã–µ –¥—Ä–µ–≤–∞
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/notifications">
                            <i class="bi bi-bell me-2"></i>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/reports">
                            <i class="bi bi-bar-chart me-2"></i>–û—Ç—á–µ—Ç—ã
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/settings">
                            <i class="bi bi-gear me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="col-md-9 ms-sm-auto col-lg-10 main-content">
            <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/admin">–ì–ª–∞–≤–Ω–∞—è</a></li>
                    <li class="breadcrumb-item active">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h4 mb-0">
                    <i class="bi bi-bell me-2"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
                </h1>
                <div>
                    <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#settingsModal">
                        <i class="bi bi-gear me-1"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createNotificationModal">
                        <i class="bi bi-plus-lg me-1"></i>–°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    </button>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card-modern stat-card bg-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 stat-icon stat-primary">
                                    <i class="bi bi-bell"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-muted fs-6">–í—Å–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                                    <div class="fs-3 fw-bold" th:text="${totalNotifications != null ? totalNotifications : '142'}">142</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-modern stat-card bg-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 stat-icon stat-danger">
                                    <i class="bi bi-bell-fill"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-muted fs-6">–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
                                    <div class="fs-3 fw-bold" th:text="${urgentNotifications != null ? urgentNotifications : '18'}">18</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-modern stat-card bg-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 stat-icon stat-success">
                                    <i class="bi bi-check-circle"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-muted fs-6">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                                    <div class="fs-3 fw-bold" th:text="${processedNotifications != null ? processedNotifications : '97'}">97</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-modern stat-card bg-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 stat-icon stat-warning">
                                    <i class="bi bi-calendar-check"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-muted fs-6">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü</div>
                                    <div class="fs-3 fw-bold" th:text="${recentNotifications != null ? recentNotifications : '32'}">32</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card-modern">
                        <div class="card-header">
                            <h5 class="card-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="notificationsChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-modern">
                        <div class="card-header">
                            <h5 class="card-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="notificationsPieChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
            <div class="card-modern mb-4">
                <div class="card-body">
                    <form th:action="@{/admin/notifications}" method="get" class="row g-3">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" name="search" th:value="${param.search}" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" name="status">
                                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                <option value="read" th:selected="${param.status == 'read'}">–ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</option>
                                <option value="unread" th:selected="${param.status == 'unread'}">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</option>
                                <option value="urgent" th:selected="${param.status == 'urgent'}">–°—Ä–æ—á–Ω—ã–µ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" name="type">
                                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                                <option value="moderation" th:selected="${param.type == 'moderation'}">–ú–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞</option>
                                <option value="technical" th:selected="${param.type == 'technical'}">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã</option>
                                <option value="user" th:selected="${param.type == 'user'}">–ó–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</option>
                                <option value="system" th:selected="${param.type == 'system'}">–°–∏—Å—Ç–µ–º–Ω—ã–µ</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
            <div class="card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title">–°–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" id="markAllRead">
                            <i class="bi bi-check-all me-1"></i>–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                        </button>
                        <button class="btn btn-sm btn-outline-danger me-2" id="cleanupNotifications">
                            <i class="bi bi-trash me-1"></i>–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                        </button>
                        <span class="badge bg-primary rounded-pill" th:text="${notifications != null ? notifications.totalElements : '1'}">1</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö -->
                        <div th:if="${notificationList == null || notificationList.isEmpty()}" class="p-4 text-center">
                            <p class="text-muted">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
                        </div>
                        
                        <div th:each="notification : ${notificationList}" 
                             th:class="'list-group-item notification-item ' + 
                                      (${!notification.read} ? 'unread' : '') + 
                                      (${notification.urgent} ? ' urgent' : '')">
                            <div class="d-flex align-items-start">
                                <!-- –ò–∫–æ–Ω–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                                <div class="flex-shrink-0 me-3">
                                    <div th:class="'notification-type ' + 
                                               (${notification.type.name() == 'MODERATION'} ? 'bg-primary bg-opacity-10 text-primary' : 
                                               (${notification.type.name() == 'TECHNICAL'} ? 'bg-danger bg-opacity-10 text-danger' :
                                               (${notification.type.name() == 'USER_REQUEST'} ? 'bg-success bg-opacity-10 text-success' :
                                               'bg-warning bg-opacity-10 text-warning')))">
                                        <i th:class="'bi ' + 
                                                  (${notification.type.name() == 'MODERATION'} ? 'bi-shield-check' : 
                                                  (${notification.type.name() == 'TECHNICAL'} ? 'bi-exclamation-triangle' :
                                                  (${notification.type.name() == 'USER_REQUEST'} ? 'bi-person-lines-fill' :
                                                  'bi-gear')))"></i>
                                    </div>
                                </div>
                                
                                <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h5 class="card-title mb-1 notification-title">
                                            <span th:text="${notification.title}">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                                            <span class="badge bg-danger ms-1" th:if="${notification.urgent}">–°—Ä–æ—á–Ω–æ</span>
                                            <!-- –°—Ç–∞—Ç—É—Å –º–æ–¥–µ—Ä–∞—Ü–∏–∏ -->
                                            <span th:if="${notification.type.name() == 'MODERATION'}" 
                                                 th:class="${notification.status.name() == 'PENDING' ? 'badge bg-warning ms-1' : 
                                                           notification.status.name() == 'ACCEPTED' ? 'badge bg-success ms-1' : 
                                                           notification.status.name() == 'REJECTED' ? 'badge bg-danger ms-1' : 'badge bg-secondary ms-1'}"
                                                 th:text="${notification.status.name() == 'PENDING' ? '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏' :
                                                          notification.status.name() == 'ACCEPTED' ? '–û–¥–æ–±—Ä–µ–Ω–æ' :
                                                          notification.status.name() == 'REJECTED' ? '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ' : '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'}">
                                                –°—Ç–∞—Ç—É—Å
                                            </span>
                                        </h5>
                                        <small class="text-muted">
                                            <span th:text="${#temporals.format(notification.createdAt, 'dd.MM.yyyy HH:mm')}">01.01.2023</span>
                                        </small>
                                    </div>
                                    
                                    <p class="card-text notification-text" th:text="${notification.message}">
                                        –¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                                    </p>
                                    
                                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ -->
                                    <div class="d-flex flex-wrap notification-meta text-muted small mb-2">
                                        <div class="me-3" th:if="${notification.sender != null}">
                                            <i class="bi bi-person me-1"></i>
                                            <span>–û—Ç: </span>
                                            <span th:text="${notification.sender.fio}">–ò–≤–∞–Ω–æ–≤ –ò.–ò.</span>
                                        </div>
                                        <div>
                                            <i class="bi bi-envelope me-1"></i>
                                            <span>–ö–æ–º—É: </span>
                                            <span th:text="${notification.user.fio}">–ü–µ—Ç—Ä–æ–≤ –ü.–ü.</span>
                                        </div>
                                    </div>
                                    
                                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                                    <div class="d-flex gap-2 mt-2">
                                        <!-- –ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å, –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
                                        <a th:if="${notification.relatedEntityId != null && notification.type.name() == 'MEMORIAL_OWNERSHIP'}" 
                                           th:href="@{/admin/memorials/{id}/edit(id=${notification.relatedEntityId})}" 
                                           class="btn btn-sm btn-primary">
                                            <i class="bi bi-eye me-1"></i>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ–º–æ—Ä–∏–∞–ª
                                        </a>
                                        
                                        <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –º–æ–¥–µ—Ä–∞—Ü–∏–∏ -->
                                        <a th:if="${notification.relatedEntityId != null && notification.type.name() == 'MODERATION'}" 
                                           th:href="@{/admin/memorials/{id}(id=${notification.relatedEntityId})}" 
                                           target="_blank"
                                           class="btn btn-sm btn-primary">
                                            <i class="bi bi-eye me-1"></i>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ–º–æ—Ä–∏–∞–ª –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                                        </a>
                                        
                                        <!-- –ö–Ω–æ–ø–∫–∏ –ø—Ä–∏–Ω—è—Ç–∏—è/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ -->
                                        <div th:if="${notification.status.name() == 'PENDING' && notification.type.name() == 'MODERATION'}">
                                            <a th:href="@{/admin/memorials/{id}/approve(id=${notification.relatedEntityId})}" 
                                               class="btn btn-sm btn-outline-success">
                                                <i class="bi bi-check-lg me-1"></i>–û–¥–æ–±—Ä–∏—Ç—å
                                            </a>
                                            <a th:href="@{/admin/memorials/{id}/reject(id=${notification.relatedEntityId})}" 
                                               class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-x-lg me-1"></i>–û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                            </a>
                                        </div>
                                        
                                        <!-- –ö–Ω–æ–ø–∫–∏ –ø—Ä–∏–Ω—è—Ç–∏—è/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ -->
                                        <div th:if="${notification.status.name() == 'PENDING' && notification.type.name() != 'MODERATION'}">
                                            <button class="btn btn-sm btn-outline-success mark-accept" 
                                                    th:data-id="${notification.id}">
                                                <i class="bi bi-check-lg me-1"></i>–û–¥–æ–±—Ä–∏—Ç—å
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger mark-reject" 
                                                    th:data-id="${notification.id}">
                                                <i class="bi bi-x-lg me-1"></i>–û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                            </button>
                                        </div>
                                        
                                        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
                                        <div th:if="${notification.type.name() == 'TECHNICAL' && notification.status.name() != 'PROCESSED'}">
                                            <button class="btn btn-sm btn-primary respond-technical" 
                                                    th:data-id="${notification.id}"
                                                    th:data-sender-name="${notification.sender != null ? notification.sender.fio : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}">
                                                <i class="bi bi-reply me-1"></i>–û—Ç–≤–µ—Ç–∏—Ç—å
                                            </button>
                                        </div>
                                        
                                        <!-- –°—Ç–∞—Ç—É—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
                                        <div th:if="${notification.type.name() == 'TECHNICAL' && notification.status.name() == 'PROCESSED'}">
                                            <span class="badge bg-success">–û—Ç–≤–µ—á–µ–Ω–æ</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ -->
                                <div class="flex-shrink-0 ms-2">
                                    <button th:if="${!notification.read}" 
                                            class="btn btn-sm btn-action btn-outline-secondary mark-read"
                                            th:data-id="${notification.id}" 
                                            title="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ">
                                        <i class="bi bi-envelope-open"></i>
                                    </button>
                                    <button th:if="${notification.read}" 
                                            class="btn btn-sm btn-action btn-outline-secondary" 
                                            disabled title="–ü—Ä–æ—á–∏—Ç–∞–Ω–æ">
                                        <i class="bi bi-check"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
                <div class="card-footer bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted" 
                                  th:text="${notificationList != null && !notificationList.isEmpty() ? 
                                           '–ü–æ–∫–∞–∑–∞–Ω–æ ' + notificationList.size() + ' –∏–∑ ' + notificationList.size() : 
                                           '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç'}">
                                –ü–æ–∫–∞–∑–∞–Ω–æ 0 –∏–∑ 0
                            </span>
                        </div>
                        <!-- –ï—Å–ª–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è –≤ –±—É–¥—É—â–µ–º, —Ç–æ –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ -->
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç—ã -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ª–∏—à–Ω–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        const cleanupBtn = document.getElementById('cleanupNotifications');
        if (cleanupBtn) {
            cleanupBtn.addEventListener('click', function() {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?')) {
                    return;
                }
                
                fetch('/admin/notifications/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`–£–¥–∞–ª–µ–Ω–æ ${data.deletedCount} –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π`);
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
                        window.location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞');
                });
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ"
        const markAllReadBtn = document.getElementById('markAllRead');
        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', function() {
                fetch('/admin/notifications/mark-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`–û—Ç–º–µ—á–µ–Ω–æ ${data.updatedCount} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞.`);
                        window.location.reload();
                    } else {
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ.');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞.');
                });
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const respondTechnicalButtons = document.querySelectorAll('.respond-technical');
        respondTechnicalButtons.forEach(button => {
            button.addEventListener('click', function() {
                const notificationId = this.getAttribute('data-id');
                const senderName = this.getAttribute('data-sender-name');
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.getElementById('responseSenderName').textContent = senderName;
                document.getElementById('responseMessage').value = '';
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
                document.getElementById('sendResponseBtn').setAttribute('data-notification-id', notificationId);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                new bootstrap.Modal(document.getElementById('technicalResponseModal')).show();
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const sendResponseBtn = document.getElementById('sendResponseBtn');
        if (sendResponseBtn) {
            sendResponseBtn.addEventListener('click', function() {
                const notificationId = this.getAttribute('data-notification-id');
                const responseMessage = document.getElementById('responseMessage').value.trim();
                
                if (!responseMessage) {
                    alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
                    return;
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                const formData = new FormData();
                formData.append('notificationId', notificationId);
                formData.append('response', responseMessage);
                
                fetch('/admin/notifications/technical-response', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('–û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é');
                        
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        bootstrap.Modal.getInstance(document.getElementById('technicalResponseModal')).hide();
                        
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                        window.location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞');
                });
            });
        }
    });
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div class="modal fade" id="createNotificationModal" tabindex="-1" aria-labelledby="createNotificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createNotificationModalLabel">
                    <i class="bi bi-bell-plus me-2"></i>–°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createNotificationForm">
                    <!-- –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                    <div class="mb-3">
                        <label for="notificationType" class="form-label">–¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
                        <select class="form-select" id="notificationType" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                            <optgroup label="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ">
                                <option value="admin_info">üìÑ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</option>
                                <option value="admin_system">‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</option>
                            </optgroup>
                            <optgroup label="–í–∞–∂–Ω—ã–µ">
                                <option value="mass_announcement">üì¢ –ú–∞—Å—Å–æ–≤–æ–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ (–≤–∞–∂–Ω–æ–µ)</option>
                                <option value="admin_warning">‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</option>
                            </optgroup>
                            <optgroup label="–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)">
                                <option value="system">–û–±—ã—á–Ω–æ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ</option>
                                <option value="technical">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ</option>
                                <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ</option>
                            </optgroup>
                        </select>
                        <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∏–ø –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ</div>
                    </div>
                    
                    <!-- –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ -->
                    <div class="mb-3">
                        <label for="recipientType" class="form-label">–ü–æ–ª—É—á–∞—Ç–µ–ª–∏</label>
                        <select class="form-select" id="recipientType" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π</option>
                            <option value="all_users">üë• –í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</option>
                            <option value="all_admins">üëë –í—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º</option>
                            <option value="specific_user">üë§ –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</option>
                            <option value="multiple_users">üë• –ù–µ—Å–∫–æ–ª—å–∫–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</option>
                        </select>
                    </div>
                    
                    <!-- –í—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                    <div class="mb-3" id="specificUserBlock" style="display: none;">
                        <label for="specificUser" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <select class="form-select" id="specificUser">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                        </select>
                    </div>
                    
                    <!-- –í—ã–±–æ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                    <div class="mb-3" id="multipleUsersBlock" style="display: none;">
                        <label for="multipleUsers" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</label>
                        <select class="form-select" id="multipleUsers" multiple size="8">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                        </select>
                        <div class="form-text">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl (Cmd) –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    </div>
                    
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                    <div class="mb-3">
                        <label for="notificationTitle" class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                        <input type="text" class="form-control" id="notificationTitle" required 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                        <div class="form-text">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—É—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                    </div>
                    
                    <!-- –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ -->
                    <div class="mb-3">
                        <label for="notificationContent" class="form-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="notificationContent" rows="5" required
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è..."></textarea>
                        <div class="form-text">–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                    </div>
                    
                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ -->
                    <div class="row">
                        <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notificationUrgent">
                            <label class="form-check-label" for="notificationUrgent">
                                    <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                                –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ —Å—Ä–æ—á–Ω–æ–µ
                            </label>
                        </div>
                    </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendEmail">
                                <label class="form-check-label" for="sendEmail">
                                    <i class="bi bi-envelope text-primary me-1"></i>
                                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i>–û—Ç–º–µ–Ω–∞
                </button>
                <button type="button" class="btn btn-primary" id="sendNotificationBtn">
                    <i class="bi bi-send me-1"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="settingsModalLabel">
                    <i class="bi bi-gear me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="notificationSettingsForm">
                    <div class="mb-3">
                        <label class="form-label">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</label>
                        <select class="form-select" id="autoDeletion">
                            <option value="never">–ù–∏–∫–æ–≥–¥–∞</option>
                            <option value="week">–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é</option>
                            <option value="month" selected>–ß–µ—Ä–µ–∑ –º–µ—Å—è—Ü</option>
                            <option value="quarter">–ß–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailNotification" checked>
                            <label class="form-check-label" for="emailNotification">
                                Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailUrgentOnly">
                            <label class="form-check-label" for="emailUrgentOnly">
                                –¢–æ–ª—å–∫–æ —Å—Ä–æ—á–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–î–∞–π–¥–∂–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</label>
                        <select class="form-select" id="digestFrequency">
                            <option value="never">–û—Ç–∫–ª—é—á–µ–Ω</option>
                            <option value="daily" selected>–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
                            <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="saveSettingsBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
<div class="modal fade" id="technicalResponseModal" tabindex="-1" aria-labelledby="technicalResponseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="technicalResponseModalLabel">
                    <i class="bi bi-reply me-2"></i>–û—Ç–≤–µ—Ç –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</label>
                    <span id="responseSenderName" class="fw-bold"></span>
                </div>
                <div class="mb-3">
                    <label for="responseMessage" class="form-label">–í–∞—à –æ—Ç–≤–µ—Ç</label>
                    <textarea class="form-control" id="responseMessage" rows="6" 
                              placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é..." required></textarea>
                    <div class="form-text">–û—Ç–≤–µ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–∞–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="sendResponseBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
            </div>
        </div>
    </div>
</div>

<script>
    // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é
    document.addEventListener('DOMContentLoaded', () => {
        const sidebar = document.getElementById('sidebarMenu');
        document.querySelector('.navbar-toggler').addEventListener('click', () => {
            sidebar.classList.toggle('show');
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const notificationType = document.getElementById('notificationType');
        const recipientType = document.getElementById('recipientType');
        const specificUserBlock = document.getElementById('specificUserBlock');
        const multipleUsersBlock = document.getElementById('multipleUsersBlock');
        const specificUser = document.getElementById('specificUser');
        const multipleUsers = document.getElementById('multipleUsers');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.getElementById('createNotificationModal').addEventListener('show.bs.modal', function() {
            loadUsers();
        });
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function loadUsers() {
            fetch('/admin/users/api/all')
                .then(response => response.json())
                .then(users => {
                    // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏
                    specificUser.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>';
                    multipleUsers.innerHTML = '';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    users.forEach(user => {
                        const option1 = new Option(`${user.fio || user.login} (${user.email})`, user.id);
                        const option2 = new Option(`${user.fio || user.login} (${user.email})`, user.id);
                        
                        specificUser.appendChild(option1);
                        multipleUsers.appendChild(option2);
                    });
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                    specificUser.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
                    multipleUsers.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
                });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
        recipientType.addEventListener('change', function() {
            const value = this.value;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –±–ª–æ–∫–∏ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            specificUserBlock.style.display = 'none';
            multipleUsersBlock.style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –±–ª–æ–∫
            if (value === 'specific_user') {
                specificUserBlock.style.display = 'block';
            } else if (value === 'multiple_users') {
                multipleUsersBlock.style.display = 'block';
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        document.getElementById('sendNotificationBtn').addEventListener('click', function() {
            const title = document.getElementById('notificationTitle').value.trim();
            const content = document.getElementById('notificationContent').value.trim();
            const type = document.getElementById('notificationType').value;
            const recipientTypeValue = recipientType.value;
            const urgent = document.getElementById('notificationUrgent').checked;
            const sendEmail = document.getElementById('sendEmail').checked;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!title || !content || !type || !recipientTypeValue) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
            let recipientIds = [];
            let recipientInfo = '';
            
            switch (recipientTypeValue) {
                case 'all_users':
                    recipientInfo = '–≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º';
                    break;
                case 'all_admins':
                    recipientInfo = '–≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º';
                    break;
                case 'specific_user':
                    const selectedUser = specificUser.value;
                    if (!selectedUser) {
                        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                        return;
                    }
                    recipientIds = [selectedUser];
                    recipientInfo = '–≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é';
                    break;
                case 'multiple_users':
                    const selectedUsers = Array.from(multipleUsers.selectedOptions).map(option => option.value);
                    if (selectedUsers.length === 0) {
                        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                        return;
                    }
                    recipientIds = selectedUsers;
                    recipientInfo = `${selectedUsers.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º`;
                    break;
            }
            
            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
            const confirmMessage = `–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "${title}" ${recipientInfo}?${urgent ? ' (–°–†–û–ß–ù–û–ï)' : ''}`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const formData = new FormData();
            formData.append('type', type);
            formData.append('title', title);
            formData.append('content', content);
            formData.append('urgent', urgent);
            formData.append('sendEmail', sendEmail);
            formData.append('recipientType', recipientTypeValue);
        
            // –î–æ–±–∞–≤–ª—è–µ–º ID –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            if (recipientIds.length > 0) {
                recipientIds.forEach(id => formData.append('recipientIds', id));
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass me-1"></i>–û—Ç–ø—Ä–∞–≤–∫–∞...';
                
            fetch('/admin/notifications/create', {
                    method: 'POST',
                body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                    alert(`–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${recipientInfo}!`);
        
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    bootstrap.Modal.getInstance(document.getElementById('createNotificationModal')).hide();
                
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('createNotificationForm').reset();
                    specificUserBlock.style.display = 'none';
                    multipleUsersBlock.style.display = 'none';
                        
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                                window.location.reload();
                    } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
            })
            .finally(() => {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-send me-1"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ';
            });
        });
    });
    
    // –ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–Ω—è–º - —Å–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ —Å –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    const ctx = document.getElementById('notificationsChart').getContext('2d');
    window.notificationsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'],
            datasets: [{
                label: '–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
                data: [0, 0, 0, 0, 0, 0, 0], // –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–º–∏
                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                borderColor: 'rgba(52, 152, 219, 1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
    
    // –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
    const pieCtx = document.getElementById('notificationsPieChart').getContext('2d');
    window.notificationsPieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: ['–ú–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞', '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã', '–ó–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', '–°–∏—Å—Ç–µ–º–Ω—ã–µ'],
            datasets: [{
                data: [0, 0, 0, 0], // –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–º–∏
                backgroundColor: [
                    'rgba(52, 152, 219, 0.7)',
                    'rgba(231, 76, 60, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(241, 196, 15, 0.7)'
                ],
                borderColor: [
                    'rgba(52, 152, 219, 1)',
                    'rgba(231, 76, 60, 1)',
                    'rgba(46, 204, 113, 1)',
                    'rgba(241, 196, 15, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
</script>

<script th:inline="javascript">
    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏–∑ Thymeleaf
    document.addEventListener('DOMContentLoaded', function() {
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –º–æ–¥–µ–ª–∏
        const chartData = /*[[${chartData}]]*/ { 
            days: ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'],
            values: [0, 0, 0, 0, 0, 0, 0]
        };
        
        const pieChartData = /*[[${pieChartData}]]*/ {
            labels: ['–ú–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞', '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã', '–ó–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', '–°–∏—Å—Ç–µ–º–Ω—ã–µ'],
            values: [0, 0, 0, 0]
        };
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ –¥–Ω—è–º
        if (window.notificationsChart) {
            window.notificationsChart.data.labels = chartData.days;
            window.notificationsChart.data.datasets[0].data = chartData.values;
            window.notificationsChart.update();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã
        if (window.notificationsPieChart) {
            window.notificationsPieChart.data.labels = pieChartData.labels;
            window.notificationsPieChart.data.datasets[0].data = pieChartData.values;
            window.notificationsPieChart.update();
        }
    });
</script>
</body>
</html> 